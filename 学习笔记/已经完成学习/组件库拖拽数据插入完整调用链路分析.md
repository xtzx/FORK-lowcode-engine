# ç»„ä»¶åº“æ‹–æ‹½æ•°æ®æ’å…¥å®Œæ•´è°ƒç”¨é“¾è·¯åˆ†æ

## ğŸ¯ **æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†æ¢³ç†äº†ä»ç»„ä»¶åº“æ‹–æ‹½ç»„ä»¶åˆ°æ•°æ®æˆåŠŸæ’å…¥æ–‡æ¡£çš„å®Œæ•´è°ƒç”¨é“¾è·¯ï¼ŒåŒ…æ‹¬æ¯ä¸ªå‡½æ•°çš„è°ƒç”¨æ¡ä»¶ã€å‚æ•°ä¼ é€’ã€æ‰§è¡Œæ•ˆæœç­‰è¯¦ç»†ä¿¡æ¯ã€‚

---

## ğŸ”— **å®Œæ•´è°ƒç”¨é“¾è·¯**

```mermaid
graph TD
    A["ğŸ–±ï¸ ç”¨æˆ·æ‹–æ‹½ç»“æŸ<br/>mouseup/dragend"] --> B["ã€æ­¥éª¤1ã€‘<br/>Designer.onDragend<br/>äº‹ä»¶å›è°ƒè§¦å‘"]
    B --> C["ã€æ­¥éª¤2ã€‘<br/>insertChildren<br/>æ‰¹é‡æ’å…¥å‡½æ•°"]
    C --> D["ã€æ­¥éª¤2.1ã€‘<br/>insertChild<br/>å•ä¸ªæ’å…¥å‡½æ•°"]
    D --> E["ã€æ­¥éª¤3ã€‘<br/>NodeChildren.insert<br/>å®¹å™¨æ’å…¥æ¥å£"]
    E --> F["ã€æ­¥éª¤3.1ã€‘<br/>NodeChildren.internalInsert<br/>å®é™…æ’å…¥å®ç°"]
    D --> G["ã€æ­¥éª¤4ã€‘<br/>DocumentModel.createNode<br/>åˆ›å»ºèŠ‚ç‚¹å®ä¾‹"]
    G --> H["ğŸ—ï¸ new Node(document, schema)<br/>èŠ‚ç‚¹å®ä¾‹åŒ–"]
    F --> I["ã€æ­¥éª¤5ã€‘<br/>Selection.selectAll<br/>è‡ªåŠ¨é€‰ä¸­æ–°èŠ‚ç‚¹"]
    I --> J["ã€æ­¥éª¤6ã€‘<br/>ActiveTracker.track<br/>èšç„¦åˆ°æ–°èŠ‚ç‚¹"]
    J --> K["âœ… æ’å…¥å®Œæˆ<br/>ç•Œé¢æ›´æ–°"]

    style A fill:#ff9999
    style B fill:#ffcc99
    style C fill:#99ccff
    style D fill:#99ccff
    style E fill:#ccff99
    style F fill:#ccff99
    style G fill:#ffccff
    style I fill:#ffff99
    style K fill:#99ff99
```

---

## ğŸ“‹ **è¯¦ç»†è°ƒç”¨åˆ†æ**

### **ã€æ­¥éª¤1ã€‘Designer.onDragend - æ‹–æ‹½ç»“æŸäº‹ä»¶å¤„ç†**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/designer/designer.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**

- ç”¨æˆ·å®Œæˆæ‹–æ‹½æ“ä½œï¼ˆmouseup æˆ– HTML5 dragendï¼‰
- Dragon å¼•æ“è§¦å‘ `dragend` äº‹ä»¶

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
interface DragEndEvent {
  dragObject: IPublicModelDragObject;  // æ‹–æ‹½å¯¹è±¡ï¼ˆåŒ…å«èŠ‚ç‚¹æˆ–æ•°æ®ï¼‰
  copy: boolean;                       // æ˜¯å¦å¤åˆ¶æ¨¡å¼
}
```

**ğŸ” å…³é”®åˆ¤æ–­é€»è¾‘ï¼š**
```typescript
// 1. æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ”¾ç½®ä½ç½®
if (loc && isLocationChildrenDetail(loc.detail) && loc.detail.valid !== false) {

  // 2. åˆ¤æ–­æ‹–æ‹½å¯¹è±¡ç±»å‹
  if (isDragNodeObject(dragObject)) {
    // æƒ…å†µAï¼šæ‹–æ‹½ç°æœ‰èŠ‚ç‚¹ï¼ˆç”»å¸ƒå†…ç§»åŠ¨ï¼‰
    nodes = insertChildren(loc.target, [...dragObject.nodes], loc.detail.index, copy);
  }
  else if (isDragNodeDataObject(dragObject)) {
    // æƒ…å†µBï¼šğŸ”¥ ç»„ä»¶åº“æ‹–æ‹½ï¼ˆæ–°å¢ç»„ä»¶ï¼‰
    const nodeData = Array.isArray(dragObject.data) ? dragObject.data : [dragObject.data];
    nodes = insertChildren(loc.target, nodeData, loc.detail.index);
  }
}
```

**ğŸ’¡ æ•ˆæœï¼š**
- æ ¹æ®æ‹–æ‹½ç±»å‹è°ƒç”¨ç›¸åº”çš„æ’å…¥é€»è¾‘
- ç»„ä»¶åº“æ‹–æ‹½èµ° `isDragNodeDataObject` åˆ†æ”¯

---

### **ã€æ­¥éª¤2ã€‘insertChildren - æ‰¹é‡æ’å…¥å‡½æ•°**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/document/node/node.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- Designer.onDragend ç¡®è®¤æœ‰æ•ˆæ”¾ç½®ä½ç½®åè°ƒç”¨

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
insertChildren(
  container: INode,                        // ç›®æ ‡çˆ¶å®¹å™¨èŠ‚ç‚¹
  nodes: INode[] | IPublicTypeNodeData[],  // è¦æ’å…¥çš„èŠ‚ç‚¹æ•°ç»„æˆ–Schemaæ•°ç»„
  at?: number | null,                      // èµ·å§‹æ’å…¥ä½ç½®
  copy?: boolean                           // æ˜¯å¦å¤åˆ¶æ¨¡å¼ï¼ˆç»„ä»¶åº“æ‹–æ‹½ä¸ºundefinedï¼‰
): INode[]
```

**ğŸ”„ å¤„ç†é€»è¾‘ï¼š**

```typescript
while ((node = nodes.pop())) {
  // é€ä¸ªè°ƒç”¨ insertChild å¤„ç†æ¯ä¸ªèŠ‚ç‚¹/æ•°æ®
  node = insertChild(container, node, index, copy);
  results.push(node);
  index = node.index; // æ›´æ–°ä¸‹ä¸€ä¸ªæ’å…¥ä½ç½®
}
```

**ğŸ’¡ æ•ˆæœï¼š**
- ç¡®ä¿å¤šä¸ªèŠ‚ç‚¹æŒ‰æ­£ç¡®é¡ºåºæ’å…¥
- è¿”å›æˆåŠŸæ’å…¥çš„èŠ‚ç‚¹å®ä¾‹æ•°ç»„

---

### **ã€æ­¥éª¤2.1ã€‘insertChild - å•ä¸ªæ’å…¥å‡½æ•°**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/document/node/node.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- insertChildren é€ä¸ªå¤„ç†èŠ‚ç‚¹æ—¶è°ƒç”¨

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
insertChild(
  container: INode,                    // ç›®æ ‡çˆ¶å®¹å™¨
  thing: INode | IPublicTypeNodeData,  // ç°æœ‰èŠ‚ç‚¹æˆ–Schemaæ•°æ®
  at?: number | null,                  // æ’å…¥ä½ç½®
  copy?: boolean                       // å¤åˆ¶æ ‡è®°
): INode | null
```

**ğŸ” ç±»å‹åˆ¤æ–­é€»è¾‘ï¼š**
```typescript
if (isNode<INode>(thing) && (copy || thing.isSlot())) {
  // æƒ…å†µ1ï¼šç°æœ‰èŠ‚ç‚¹éœ€è¦å¤åˆ¶
  nodeSchema = thing.export(IPublicEnumTransformStage.Clone);
  node = container.document?.createNode(nodeSchema);
}
else if (isNode<INode>(thing)) {
  // æƒ…å†µ2ï¼šç°æœ‰èŠ‚ç‚¹ç›´æ¥ç§»åŠ¨
  node = thing;
}
else if (isNodeSchema(thing)) {
  // æƒ…å†µ3ï¼šğŸ”¥ ç»„ä»¶åº“æ•°æ®ï¼Œéœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹
  node = container.document?.createNode(thing);
}
```

**ğŸ’¡ æ•ˆæœï¼š**
- ç»„ä»¶åº“æ‹–æ‹½èµ°æƒ…å†µ3ï¼šè°ƒç”¨ createNode åˆ›å»ºæ–°å®ä¾‹
- ç„¶åè°ƒç”¨ container.children?.insert(node, at)

---

### **ã€æ­¥éª¤3ã€‘NodeChildren.insert - å®¹å™¨æ’å…¥æ¥å£**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/document/node/node-children.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- insertChild è·å¾—æœ‰æ•ˆèŠ‚ç‚¹å®ä¾‹åè°ƒç”¨

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
insert(node: INode, at?: number | null): void
```

**ğŸ”„ å¤„ç†é€»è¾‘ï¼š**

```typescript
// ç›´æ¥è°ƒç”¨å†…éƒ¨å®ç°ï¼Œå¯ç”¨å˜æ›´å™¨
this.internalInsert(node, at, true);
```

**ğŸ’¡ æ•ˆæœï¼š**
- ç»Ÿä¸€çš„æ’å…¥æ¥å£ï¼Œå¯ç”¨å†å²è®°å½•åŠŸèƒ½

---

### **ã€æ­¥éª¤3.1ã€‘NodeChildren.internalInsert - å®é™…æ’å…¥å®ç°**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/document/node/node-children.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- insert æ–¹æ³•è°ƒç”¨ï¼Œæ‰§è¡Œå®é™…çš„èŠ‚ç‚¹æ’å…¥æ“ä½œ

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
internalInsert(node: INode, at?: number | null, useMutator = true): void
```

**ğŸ” å…³é”®é€»è¾‘ï¼š**
```typescript
// 1. ä½ç½®è®¡ç®—
let index = at == null || at === -1 ? children.length : at;

// 2. æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨
const i = children.map(d => d.id).indexOf(node.id);

// 3. å¤„ç†åŸæœ‰çˆ¶å®¹å™¨å…³ç³»
if (node.parent) {
  editor?.eventBus.emit('node.remove.topLevel', { node, index: node.index });
}

// 4. æ‰§è¡Œå®é™…æ’å…¥
if (i < 0) {
  children.splice(index, 0, node);  // æ–°å¢
  node.internalSetParent(this.owner, useMutator);
} else {
  // ä½ç½®ç§»åŠ¨é€»è¾‘...
}
```

**ğŸ”” äº‹ä»¶è§¦å‘ï¼š**
```typescript
this.emitter.emit('change', { type: 'insert', node });
this.emitter.emit('insert', node);
editor?.eventBus.emit('node.add', { node });
```

**ğŸ’¡ æ•ˆæœï¼š**
- èŠ‚ç‚¹çœŸæ­£æ’å…¥åˆ°DOMæ ‘ç»“æ„ä¸­
- å»ºç«‹æ­£ç¡®çš„çˆ¶å­å…³ç³»
- è§¦å‘å„ç§å˜åŒ–äº‹ä»¶

---

### **ã€æ­¥éª¤4ã€‘DocumentModel.createNode - åˆ›å»ºèŠ‚ç‚¹å®ä¾‹**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/document/document-model.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- insertChild å¤„ç† Schema æ•°æ®æ—¶è°ƒç”¨

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
createNode<T extends INode>(data: NodeSchema): T
```

**ğŸ” å¤„ç†é€»è¾‘ï¼š**

```typescript
// 1. Schema æ ‡å‡†åŒ–
if (isDOMText(data) || isJSExpression(data)) {
  schema = { componentName: 'Leaf', children: data };
} else {
  schema = data;  // ğŸ”¥ ç»„ä»¶åº“æ•°æ®èµ°è¿™é‡Œ
}

// 2. ID å†²çªæ£€æŸ¥
if (this.hasNode(schema?.id)) {
  schema.id = null;  // æ¸…é™¤å†²çªIDï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
}

// 3. åˆ›å»ºèŠ‚ç‚¹å®ä¾‹
node = new Node(this, schema);
```

**ğŸ“ èŠ‚ç‚¹æ³¨å†Œï¼š**
```typescript
this._nodesMap.set(node.id, node);  // IDæ˜ å°„è¡¨
this.nodes.add(node);                // èŠ‚ç‚¹é›†åˆ
this.emitter.emit('nodecreate', node);  // åˆ›å»ºäº‹ä»¶
```

**ğŸ’¡ æ•ˆæœï¼š**
- Schema æ•°æ®è½¬æ¢ä¸º Node å®ä¾‹
- èŠ‚ç‚¹æ³¨å†Œåˆ°æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ
- è§¦å‘èŠ‚ç‚¹åˆ›å»ºäº‹ä»¶

---

### **ã€æ­¥éª¤5ã€‘Selection.selectAll - è‡ªåŠ¨é€‰ä¸­æ–°èŠ‚ç‚¹**

**ğŸ“ æ–‡ä»¶ï¼š** `packages/designer/src/document/selection.ts`

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- Designer.onDragend æ’å…¥æˆåŠŸåè°ƒç”¨

**ğŸ“¥ è¾“å…¥å‚æ•°ï¼š**

```typescript
selectAll(ids: string[]): void  // æ–°æ’å…¥èŠ‚ç‚¹çš„IDæ•°ç»„
```

**ğŸ” å¤„ç†é€»è¾‘ï¼š**

```typescript
ids.forEach(id => {
  const node = this.doc.getNode(id);
  if (node?.canSelect()) {  // æ£€æŸ¥æ˜¯å¦å¯é€‰ä¸­
    selectIds.push(id);
  }
});

this._selected = selectIds;
this.emitter.emit('selectionchange', this._selected);
```

**ğŸ’¡ æ•ˆæœï¼š**
- è‡ªåŠ¨é€‰ä¸­æ–°æ’å…¥çš„èŠ‚ç‚¹
- è§¦å‘é€‰ä¸­å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°UIçŠ¶æ€

---

### **ã€æ­¥éª¤6ã€‘ActiveTracker.track - èšç„¦åˆ°æ–°èŠ‚ç‚¹**

**ğŸ¯ è°ƒç”¨æ¡ä»¶ï¼š**
- Designer.onDragend é€‰ä¸­åå»¶è¿Ÿ10msè°ƒç”¨

**ğŸ’¡ æ•ˆæœï¼š**
- æ»šåŠ¨åˆ°æ–°èŠ‚ç‚¹å¯è§†åŒºåŸŸ
- ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ–°æ’å…¥çš„èŠ‚ç‚¹

---

## ğŸ¨ **å…³é”®æ•°æ®æµè½¬**

### **ç»„ä»¶åº“æ‹–æ‹½æ•°æ®æµï¼š**

```mermaid
NodeData(Schema) â†’ insertChildren â†’ insertChild â†’ createNode â†’ Nodeå®ä¾‹ â†’ internalInsert â†’ æ’å…¥å®Œæˆ
     â†“               â†“                â†“              â†“              â†“              â†“
ç»„ä»¶åº“æ•°æ®      æ‰¹é‡å¤„ç†         ç±»å‹åˆ¤æ–­      å®ä¾‹åŒ–         èŠ‚ç‚¹å¯¹è±¡      DOMæ ‘æ’å…¥
```

### **å‚æ•°ä¼ é€’é“¾ï¼š**

```javascript
dragObject.data â†’ nodeData â†’ thing â†’ schema â†’ new Node() â†’ node â†’ childrenæ•°ç»„
```

---

## âš¡ **æ€§èƒ½ä¼˜åŒ–ç‚¹**

1. **æ‰¹é‡æ’å…¥ä¼˜åŒ–ï¼š** ä½¿ç”¨ `while + pop()` ç¡®ä¿æ’å…¥é¡ºåº
2. **äº‹ä»¶å»¶è¿Ÿï¼š** `setTimeout(() => track(node), 10)` é¿å…é˜»å¡
3. **IDå†²çªå¤„ç†ï¼š** è‡ªåŠ¨é‡æ–°ç”Ÿæˆå†²çªID
4. **é€‰ä¸­è¿‡æ»¤ï¼š** åªé€‰ä¸­ `canSelect()` çš„èŠ‚ç‚¹

---

## ğŸ› **å¸¸è§é—®é¢˜æ’æŸ¥**

### **1. èŠ‚ç‚¹æ’å…¥å¤±è´¥**
- æ£€æŸ¥ `loc.detail.valid` æ˜¯å¦ä¸º `false`
- ç¡®è®¤ `isNodeSchema(thing)` åˆ¤æ–­æ˜¯å¦æ­£ç¡®
- éªŒè¯å®¹å™¨èŠ‚ç‚¹æ˜¯å¦æ”¯æŒå­èŠ‚ç‚¹

### **2. é€‰ä¸­çŠ¶æ€å¼‚å¸¸**
- æ£€æŸ¥èŠ‚ç‚¹çš„ `canSelect()` æ–¹æ³•è¿”å›å€¼
- ç¡®è®¤ `selectionchange` äº‹ä»¶æ˜¯å¦æ­£ç¡®è§¦å‘
- éªŒè¯èŠ‚ç‚¹IDæ˜¯å¦æ­£ç¡®ç”Ÿæˆ

### **3. å†å²è®°å½•é—®é¢˜**
- ç¡®è®¤ `useMutator` å‚æ•°ä¸º `true`
- æ£€æŸ¥ `reportModified` æ˜¯å¦è¢«è°ƒç”¨
- éªŒè¯å˜æ›´å™¨åŠŸèƒ½æ˜¯å¦æ­£å¸¸å¯ç”¨

---

## ğŸ“š **ç›¸å…³æ–‡ä»¶æ¸…å•**

| æ–‡ä»¶è·¯å¾„ | ä¸»è¦èŒè´£ | å…³é”®æ–¹æ³• |
|---------|---------|---------|
| `packages/designer/src/designer/designer.ts` | æ‹–æ‹½äº‹ä»¶å¤„ç† | `onDragend` |
| `packages/designer/src/document/node/node.ts` | èŠ‚ç‚¹æ’å…¥é€»è¾‘ | `insertChildren`, `insertChild` |
| `packages/designer/src/document/node/node-children.ts` | å­èŠ‚ç‚¹ç®¡ç† | `insert`, `internalInsert` |
| `packages/designer/src/document/document-model.ts` | èŠ‚ç‚¹åˆ›å»ºç®¡ç† | `createNode` |
| `packages/designer/src/document/selection.ts` | é€‰ä¸­çŠ¶æ€ç®¡ç† | `selectAll` |

---

## âœ… **æ€»ç»“**

ç»„ä»¶åº“æ‹–æ‹½æ•°æ®æ’å…¥æ˜¯ä¸€ä¸ªå¤æ‚çš„å¤šæ­¥éª¤è¿‡ç¨‹ï¼Œæ¶‰åŠï¼š

1. **äº‹ä»¶é©±åŠ¨**ï¼šæ‹–æ‹½å¼•æ“è§¦å‘ `dragend` äº‹ä»¶
2. **ç±»å‹åˆ¤æ–­**ï¼šåŒºåˆ†èŠ‚ç‚¹å¯¹è±¡å’Œæ•°æ®å¯¹è±¡
3. **æ•°æ®è½¬æ¢**ï¼šSchema â†’ Node å®ä¾‹
4. **ç»“æ„æ’å…¥**ï¼šå»ºç«‹æ­£ç¡®çš„çˆ¶å­å…³ç³»
5. **çŠ¶æ€åŒæ­¥**ï¼šé€‰ä¸­çŠ¶æ€å’Œç•Œé¢æ›´æ–°
6. **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨èšç„¦åˆ°æ–°èŠ‚ç‚¹

æ•´ä¸ªæµç¨‹è®¾è®¡ç²¾å·§ï¼Œæ—¢ä¿è¯äº†æ•°æ®çš„æ­£ç¡®æ€§ï¼Œåˆæä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚
