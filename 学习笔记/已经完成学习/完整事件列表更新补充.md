# ä½ä»£ç å¼•æ“å®Œæ•´äº‹ä»¶åˆ—è¡¨æ›´æ–°è¡¥å……

## ğŸ” å‘ç°çš„é—æ¼äº‹ä»¶

### 1. `detectingChange` äº‹ä»¶ âš ï¸ **é‡è¦é—æ¼**

**å®šä¹‰ä½ç½®**: `packages/designer/src/designer/detecting.ts`
**äº‹ä»¶å¸¸é‡**: `DETECTING_CHANGE_EVENT = 'detectingChange'`

```typescript
// äº‹ä»¶è§¦å‘ä½ç½®
capture(node) {
  if (this._current !== node) {
    this._current = node;
    this.emitter.emit(DETECTING_CHANGE_EVENT, this.current);
  }
}

release(node) {
  if (this._current === node) {
    this._current = null;
    this.emitter.emit(DETECTING_CHANGE_EVENT, this.current);
  }
}
```

**äº‹ä»¶ç”¨é€”**:
- é¼ æ ‡æ‚¬åœèŠ‚ç‚¹å˜åŒ–æ—¶è§¦å‘
- ä¸»è¦è¢« `BorderDetecting` ç»„ä»¶ç›‘å¬
- ç”¨äºæ˜¾ç¤ºæ‚¬åœè¾¹æ¡†å’Œç»„ä»¶ä¿¡æ¯
- ä¸å¤§çº²é¢æ¿çš„æ‚¬åœåŒæ­¥

### 2. `selectionchange` ä¸ `selection.change` çš„åŒºåˆ«

**ä¸¤ä¸ªä¸åŒå±‚çº§çš„é€‰æ‹©äº‹ä»¶**:

| äº‹ä»¶å | è§¦å‘å±‚çº§ | æ•°æ®æ ¼å¼ | ç”¨é€” |
|-------|---------|----------|------|
| `selectionchange` | Selectionæ¨¡å—å†…éƒ¨ | `string[]` (èŠ‚ç‚¹IDæ•°ç»„) | åº•å±‚çŠ¶æ€å˜æ›´ |
| `selection.change` | Designerå±‚å¹¿æ’­ | `Selectionå®ä¾‹` | ä¸Šå±‚ä¸šåŠ¡é€šçŸ¥ |

```typescript
// selectionchange - Selectionæ¨¡å—å†…éƒ¨
Selection.select(id) {
  this._selected = [id];
  this.emitter.emit('selectionchange', this._selected);
}

// selection.change - Designerå±‚è½¬å‘
Designer.setupSelection() {
  currentSelection.onSelectionChange(() => {
    this.postEvent('selection.change', currentSelection);
  });
}
```

## ğŸ“Š å®Œæ•´äº‹ä»¶å±‚çº§æ¶æ„

```mermaid
graph TB
    subgraph "åº•å±‚äº‹ä»¶æº"
        A[Selectionå†…éƒ¨äº‹ä»¶<br/>selectionchange]
        B[Detectingå†…éƒ¨äº‹ä»¶<br/>detectingChange]
        C[Dragonå†…éƒ¨äº‹ä»¶<br/>dragstart/drag/dragend]
        D[Historyå†…éƒ¨äº‹ä»¶<br/>å†å²è®°å½•å˜æ›´]
    end

    subgraph "ä¸­é—´è½¬å‘å±‚"
        E[Designer.postEvent<br/>äº‹ä»¶å¹¿æ’­]
        F[Editor.eventBus<br/>å…¨å±€äº‹ä»¶æ€»çº¿]
    end

    subgraph "ä¸Šå±‚æ¶ˆè´¹è€…"
        G[BemToolsè§†è§‰è¾…åŠ©]
        H[OutlinePaneå¤§çº²é¢æ¿]
        I[SettingPanelå±æ€§é¢æ¿]
        J[å¤–éƒ¨ä¸šåŠ¡ä»£ç ]
        K[æ’ä»¶ç³»ç»Ÿ]
    end

    A --> E
    B --> G
    C --> E
    D --> E

    E --> F
    F --> G
    F --> H
    F --> I
    F --> J
    F --> K

    style B fill:#ff9800
    style G fill:#4caf50
```

## ğŸ”§ ç›‘å¬æ–¹å¼å¯¹æ¯”

### åº•å±‚äº‹ä»¶ç›‘å¬ï¼ˆç›´æ¥ï¼‰
```typescript
// ç›´æ¥ç›‘å¬ Selection å†…éƒ¨äº‹ä»¶
currentDocument.selection.emitter.on('selectionchange', (selectedIds) => {
  console.log('åº•å±‚é€‰æ‹©å˜åŒ–:', selectedIds);
});

// ç›´æ¥ç›‘å¬ Detecting å†…éƒ¨äº‹ä»¶
designer.detecting.onDetectingChange((node) => {
  console.log('æ‚¬åœå˜åŒ–:', node?.componentName);
});
```

### ä¸Šå±‚äº‹ä»¶ç›‘å¬ï¼ˆå¹¿æ’­ï¼‰
```typescript
// ç›‘å¬ Designer å¹¿æ’­çš„äº‹ä»¶
editor.eventBus.on('selection.change', (selection) => {
  console.log('ä¸Šå±‚é€‰æ‹©å˜åŒ–:', selection.selected);
});

// ç›‘å¬ Editor å…¨å±€äº‹ä»¶
editor.eventBus.on('dragstart', (e) => {
  console.log('å…¨å±€æ‹–æ‹½å¼€å§‹:', e);
});
```

## ğŸ¯ äº‹ä»¶ä½¿ç”¨åœºæ™¯

### BemTools ä¸­çš„äº‹ä»¶ä½¿ç”¨

```typescript
// BorderDetecting ç»„ä»¶å“åº”æ‚¬åœäº‹ä»¶
@computed get current() {
  var current = host.designer.detecting.current;

  // å¦‚æœå·²é€‰ä¸­åˆ™ä¸æ˜¾ç¤ºæ‚¬åœè¾¹æ¡†
  if (!current || selection.has(current.id)) {
    return null;
  }

  return current;
}
```

### å¤§çº²é¢æ¿çš„äº‹ä»¶åŒæ­¥

```typescript
// TreeView æ‚¬åœæ—¶åŒæ­¥è§¦å‘æ£€æµ‹
hover(e) {
  var detecting = project.currentDocument?.detecting;
  var node = this.getTreeNodeFromEvent(e)?.node;

  // ç›´æ¥è°ƒç”¨ detecting.capture è§¦å‘ detectingChange äº‹ä»¶
  node?.id && detecting?.capture(node.id);
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. äº‹ä»¶é¢‘ç‡æ§åˆ¶
```typescript
// é«˜é¢‘äº‹ä»¶éœ€è¦èŠ‚æµ
import { throttle } from 'lodash';

const throttledDetectingHandler = throttle((node) => {
  // å¤„ç†æ‚¬åœå˜åŒ–
  this.updateHoverUI(node);
}, 16); // 60fps

designer.detecting.onDetectingChange(throttledDetectingHandler);
```

### 2. æ¡ä»¶æ€§ç›‘å¬
```typescript
// åªåœ¨è®¾è®¡æ¨¡å¼ä¸‹ç›‘å¬æŸäº›äº‹ä»¶
if (engineConfig.get('designMode') === 'design') {
  designer.detecting.onDetectingChange(this.handleHover);
}

// æ‹–æ‹½æ—¶æš‚åœæ‚¬åœæ£€æµ‹
designer.dragon.onDragstart(() => {
  designer.detecting.enable = false;
});

designer.dragon.onDragend(() => {
  designer.detecting.enable = true;
});
```

## ğŸ” å…¶ä»–å¯èƒ½é—æ¼çš„äº‹ä»¶æ£€æŸ¥

åŸºäºæºç åˆ†æï¼Œè¿˜éœ€è¦ç¡®è®¤æ˜¯å¦é—æ¼äº†ä»¥ä¸‹äº‹ä»¶ï¼š

### History ç›¸å…³äº‹ä»¶
- `history.stateChange` - å†å²çŠ¶æ€å˜åŒ–
- `history.savePoint` - ä¿å­˜ç‚¹è®¾ç½®

### ActiveTracker ç›¸å…³äº‹ä»¶
- `activeTracker.change` - æ´»è·ƒèŠ‚ç‚¹è·Ÿè¸ªå˜åŒ–

### ComponentMeta ç›¸å…³äº‹ä»¶
- `metadata.change` - ç»„ä»¶å…ƒæ•°æ®å˜åŒ–

### Simulator ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
- `simulator.ready` - æ¨¡æ‹Ÿå™¨å°±ç»ª
- `simulator.mount` - æ¨¡æ‹Ÿå™¨æŒ‚è½½

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [x] `detectingChange` äº‹ä»¶å·²è¡¥å……
- [x] `selectionchange` vs `selection.change` å·²æ¾„æ¸…
- [x] ç›‘å¬ç¤ºä¾‹ä»£ç å·²æ›´æ–°
- [x] è°ƒè¯•å·¥å…·å·²åŒ…å«æ–°äº‹ä»¶
- [ ] éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤ History/ActiveTracker ç›¸å…³äº‹ä»¶
- [ ] éœ€è¦éªŒè¯ ComponentMeta å˜æ›´äº‹ä»¶
- [ ] éœ€è¦ç¡®è®¤ Simulator ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

## ğŸ“ æ€»ç»“

1. **`detectingChange` æ˜¯ä¸€ä¸ªé‡è¦çš„é—æ¼äº‹ä»¶**ï¼Œè´Ÿè´£æ‚¬åœæ£€æµ‹åŠŸèƒ½
2. **éœ€è¦åŒºåˆ†åº•å±‚äº‹ä»¶å’Œå¹¿æ’­äº‹ä»¶**ï¼Œå®ƒä»¬æœåŠ¡äºä¸åŒçš„ä½¿ç”¨åœºæ™¯
3. **BemTools å¤§é‡ä¾èµ– `detectingChange` äº‹ä»¶**æ¥æä¾›è§†è§‰åé¦ˆ
4. **äº‹ä»¶ç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„**ï¼Œåº•å±‚è§¦å‘ï¼Œä¸­å±‚è½¬å‘ï¼Œä¸Šå±‚æ¶ˆè´¹

æ„Ÿè°¢æ‚¨çš„æé†’ï¼Œè¿™ç¡®ä¿äº†äº‹ä»¶åˆ—è¡¨çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ï¼
