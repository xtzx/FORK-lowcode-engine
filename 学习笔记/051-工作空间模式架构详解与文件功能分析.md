# 051-工作空间模式架构详解与文件功能分析

## 🎯 核心概念

工作空间模式（Workspace Mode）是阿里低代码引擎的高级多窗口管理功能，支持在同一个界面中管理多个项目、页面或外部系统，类似于 VS Code 的多文件标签页功能。

## 🔍 核心文件功能分析

### 1️⃣ webview.tsx - 外部系统集成插件

**核心功能**：为工作空间提供外部网页集成能力

```typescript
// 🌐 WebView 组件：用于嵌入外部系统
export function DesignerView(props: {
  url: string;        // 外部系统的 URL 地址
  viewName?: string;  // 视图标识名称
}) {
  return (
    <div className="lc-designer lowcode-plugin-designer">
      <div className="lc-project">
        <div className="lc-simulator-shell">
          {/* 🔥 核心：iframe 容器，用于嵌入外部系统 */}
          <iframe
            name={`webview-view-${props.viewName}`}    // 动态名称，避免冲突
            className="lc-simulator-content-frame"     // 复用模拟器样式
            style={{ height: '100%', width: '100%' }} // 全屏显示
            src={props.url}                           // 加载外部 URL
          />
        </div>
      </div>
    </div>
  );
}

// 🎯 插件工厂函数：为特定 URL 创建 webview 插件
export function getWebviewPlugin(url: string, viewName: string) {
  function webviewPlugin(ctx: IPublicModelPluginContext) {
    const { skeleton } = ctx;
    return {
      init() {
        // 🚀 将 webview 注册到主编辑区域
        skeleton.add({
          area: 'mainArea',        // 注册到主区域
          name: 'designer',        // 插件名称
          type: 'Widget',          // 组件类型
          content: DesignerView,   // 实际渲染的组件
          contentProps: { ctx, url, viewName }, // 传递给组件的属性
        });
      },
    };
  }

  webviewPlugin.pluginName = '___webview_plugin___';
  return webviewPlugin;
}
```

**🎪 使用场景**：
- **第三方工具集成**：如 Figma、蓝湖等设计工具
- **外部管理系统**：CMS、资产管理、用户管理等
- **独立应用嵌入**：已有的业务系统、报表系统等
- **跨技术栈集成**：Vue/Angular 应用嵌入到 React 工作空间

### 2️⃣ window-view.tsx - 窗口渲染策略控制器

**核心功能**：根据资源类型和状态选择不同的渲染策略

```typescript
@observer
export class WindowView extends PureComponent<{
  window: EditorWindow;  // 编辑器窗口实例
  active: boolean;       // 是否为当前激活窗口
}> {
  render() {
    const { active } = this.props;
    const { resource, initReady, url } = this.props.window;

    // 🔄 阶段1：初始化加载状态
    if (!initReady) {
      const Loading = engineConfig.get('loadingComponent', BuiltinLoading);
      return (
        <div className={`workspace-engine-main ${active ? 'active' : ''}`}>
          <Loading /> {/* 显示加载动画，等待窗口初始化完成 */}
        </div>
      );
    }

    // 🌐 阶段2：WebView 类型渲染（外部系统）
    if (resource.type === 'webview' && url) {
      return <DesignerView url={url} viewName={resource.name} />;
    }

    // 🎨 阶段3：Editor 类型渲染（低代码编辑器）
    return (
      <div className={`workspace-engine-main ${active ? 'active' : ''}`}>
        <ResourceView resource={resource} window={this.props.window} />
      </div>
    );
  }
}
```

**🔧 核心职责**：
- **渲染策略路由**：根据资源类型选择不同的渲染方式
- **生命周期管理**：控制窗口的加载、激活、销毁状态
- **资源类型适配**：支持 `editor` 和 `webview` 两种资源类型

## 🏗️ packages/workspace/src 完整架构解析

### 📊 架构分层图

```
🎯 核心管理层
├── workspace.ts        - 工作空间管理器，多窗口协调
├── window.ts          - 编辑器窗口，生命周期管理
├── resource.ts        - 资源管理器，数据抽象层
└── resource-type.ts   - 资源类型，类型定义系统

🎨 视图渲染层
├── view/
│   ├── window-view.tsx    - 窗口视图，渲染策略路由
│   ├── resource-view.tsx  - 资源视图，编辑器内容渲染
│   └── editor-view.tsx    - 编辑器视图，单个编辑器实例
└── layouts/
    └── workbench.tsx      - 工作台布局，多窗口UI框架

🔧 上下文管理层
├── context/
│   ├── base-context.ts    - 基础上下文，服务实例创建
│   └── view-context.ts    - 视图上下文，视图级别管理
└── skeleton-context.ts    - 骨架上下文，布局系统传递

🔌 插件系统
└── inner-plugins/
    └── webview.tsx        - WebView插件，外部系统集成
```

### 📂 详细文件功能解析

#### 🎯 核心管理层

**workspace.ts - 工作空间核心管理器**
```typescript
export class Workspace implements IWorkspace {
  @obx.ref windows: IEditorWindow[] = [];        // 所有打开的窗口列表
  @obx.ref window: IEditorWindow;                // 当前活跃窗口
  resourceTypeMap: Map<string, ResourceType>;    // 注册的资源类型映射

  // 🔥 核心功能
  async openEditorWindowByResource(resource: IResource): Promise<void>
  registerResourceType(resourceTypeModel: IPublicTypeResourceType): Promise<void>
  setResourceList(resourceList: IPublicResourceList): void
}
```

**实际作用**：
- **多窗口管理**：维护所有打开窗口的状态和切换
- **资源类型系统**：支持扩展不同类型的编辑资源
- **窗口队列**：管理窗口打开顺序和依赖关系

**window.ts - 编辑器窗口生命周期管理**
```typescript
export class EditorWindow implements IEditorWindow {
  @obx editorViews: Map<string, Context> = new Map();  // 窗口内的多个视图
  @obx initReady = false;                               // 初始化状态

  async init(): void                                    // 异步初始化
  async save(): Promise<any>                           // 保存窗口数据
  changeViewName(name: string): void                   // 切换视图
}
```

**实际作用**：
- **多视图支持**：一个窗口可包含多个编辑视图（如设计器、代码编辑器）
- **异步初始化**：确保资源加载完成后再显示内容
- **数据持久化**：统一管理窗口内所有数据的保存

**resource.ts - 资源抽象管理器**
```typescript
export class Resource implements IResource {
  resourceTypeInstance: IPublicResourceTypeConfig;  // 资源类型配置实例

  async import(schema: any): Promise<any>            // 导入数据
  async save(value: any): Promise<any>              // 保存数据
  async url(): Promise<string | undefined>          // 获取资源URL
}
```

**实际作用**：
- **资源抽象**：为不同类型资源提供统一接口
- **数据操作**：标准化导入、导出、保存操作
- **动态配置**：支持运行时动态配置资源行为

#### 🎨 视图渲染层

**view/resource-view.tsx - 资源内容渲染器**
```typescript
export class ResourceView extends PureComponent {
  render() {
    return (
      <div className="workspace-resource-view">
        <TopArea area={skeleton.topArea} />           {/* 资源级顶部工具栏 */}
        <div className="workspace-editor-body">
          {Array.from(editorViews.values()).map((editorView) => (
            <EditorView key={editorView.name} active={editorView.active} editorView={editorView} />
          ))}
        </div>
      </div>
    );
  }
}
```

**实际作用**：
- **多视图渲染**：支持同一资源的多种编辑视图
- **独立骨架**：每个资源有独立的工具栏和布局
- **视图切换**：管理多个视图的激活状态

**layouts/workbench.tsx - 多窗口工作台布局**
```typescript
export class Workbench extends Component {
  render() {
    return (
      <div className="lc-workspace-workbench">
        <TopArea area={skeleton.topArea} />                    {/* 全局工具栏 */}
        <div className="lc-workspace-workbench-body">
          <LeftArea area={skeleton.leftArea} />               {/* 左侧面板 */}
          <div className="lc-workspace-workbench-center">
            <SubTopArea area={skeleton.subTopArea} />         {/* 窗口标签页 */}
            <div className="lc-workspace-workbench-window">
              {workspace.windows.map((d) => (                {/* 🔥 多窗口渲染 */}
                <WindowView active={d.id === workspace.window?.id} window={d} key={d.id} />
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }
}
```

**实际作用**：
- **多窗口UI框架**：为多个窗口提供统一的布局容器
- **标签页管理**：窗口切换和标签页显示
- **全局面板**：左侧组件库、底部控制台等全局工具

#### 🔧 上下文管理层

**context/base-context.ts - 基础服务上下文**
```typescript
export class BasicContext implements IBasicContext {
  constructor(innerWorkspace: IWorkspace, viewName: string, registerLevel: IPublicEnumPluginRegisterLevel) {
    const editor = new Editor(viewName, true);              // 为每个上下文创建独立编辑器
    const designer = new Designer({ editor, viewName });    // 创建独立设计器
    const innerSkeleton = new InnerSkeleton(editor);        // 创建独立骨架
    // ... 创建其他服务实例
  }
}
```

**实际作用**：
- **服务实例化**：为每个视图/资源创建独立的服务实例
- **依赖注入**：提供完整的API服务集合
- **作用域隔离**：确保不同上下文之间的数据隔离

**context/view-context.ts - 视图级别上下文**
```typescript
export class Context extends BasicContext implements IViewContext {
  init = flow(function* (this: Context) {
    if (this.viewType === 'webview') {
      const url = yield this.instance?.url?.();
      yield this.plugins.register(getWebviewPlugin(url, this.viewName));  // WebView 插件注册
    } else {
      yield this.registerInnerPlugins();                                  // Editor 插件注册
    }
    yield this.instance?.init?.();
    yield this.innerPlugins.init();
    this.isInit = true;
  });
}
```

**实际作用**：
- **视图类型处理**：根据视图类型（editor/webview）选择不同初始化流程
- **插件管理**：管理视图级别的插件注册和初始化
- **异步初始化**：使用 MobX flow 管理复杂的异步初始化流程

## 🎪 业务配置使用指南

### 1. 启用工作空间模式

```typescript
import { init } from '@alilc/lowcode-engine';

// 启用工作空间模式
await init(document.getElementById('container'), {
  enableWorkspaceMode: true,  // 🔥 关键配置
  // 其他配置...
});
```

### 2. 注册资源类型

```typescript
import { workspace } from '@alilc/lowcode-engine';

// 注册低代码编辑器资源类型
await workspace.registerResourceType({
  resourceName: 'page-editor',           // 资源类型名称
  resourceType: 'editor',                // 类型：editor 或 webview
  defaultTitle: '页面编辑器',             // 默认标题
  icon: <PageIcon />,                    // 图标
  editorViews: [                         // 支持的编辑视图
    {
      viewName: 'design',               // 设计视图
      viewType: 'editor',
      init: (ctx, options) => ({
        save: async () => { /* 保存逻辑 */ },
      }),
    },
    {
      viewName: 'code',                 // 代码视图
      viewType: 'editor',
      init: (ctx, options) => ({
        save: async () => { /* 代码保存逻辑 */ },
      }),
    },
  ],
});

// 注册外部系统资源类型
await workspace.registerResourceType({
  resourceName: 'figma-design',
  resourceType: 'webview',               // WebView 类型
  defaultTitle: 'Figma 设计',
  icon: <FigmaIcon />,
  url: async () => 'https://figma.com/file/xxx',  // 返回外部系统 URL
});
```

### 3. 设置资源列表

```typescript
// 设置可用的资源列表
workspace.setResourceList([
  {
    resourceName: 'page-editor',
    title: '首页',
    id: 'homepage',
    options: {
      schema: homePageSchema,
      componentMeta: componentMetas,
    },
  },
  {
    resourceName: 'page-editor',
    title: '商品页',
    id: 'productpage',
    options: {
      schema: productPageSchema,
    },
  },
  {
    resourceName: 'figma-design',
    title: '设计稿',
    id: 'design-draft',
    viewName: 'figma-view',
  },
]);
```

### 4. 打开和管理窗口

```typescript
// 通过资源打开窗口
const resource = workspace.getResourceList().find(r => r.id === 'homepage');
await workspace.openEditorWindowByResource(resource);

// 切换活跃窗口
workspace.onChangeActiveWindow(() => {
  console.log('当前活跃窗口:', workspace.window.title);
});

// 保存当前窗口
await workspace.window.save();

// 关闭窗口
workspace.removeEditorWindowByResource(resource);
```

### 5. 自定义空工作区组件

```typescript
import { engineConfig } from '@alilc/lowcode-engine';

// 设置空工作区欢迎页
engineConfig.set('workspaceEmptyComponent', () => (
  <div className="welcome-workspace">
    <h2>欢迎使用低代码工作空间</h2>
    <p>选择一个项目开始编辑，或创建新项目</p>
    <button onClick={() => createNewProject()}>创建新项目</button>
  </div>
));
```

## 🎯 核心优势

### 1. **多项目管理**
- 同时编辑多个页面或项目
- 窗口间快速切换，保持编辑状态
- 独立的保存和版本管理

### 2. **外部系统集成**
- 无缝嵌入第三方设计工具
- 支持跨技术栈应用集成
- 统一的工作台界面

### 3. **资源类型扩展**
- 灵活的资源类型定义
- 支持自定义编辑器视图
- 动态插件注册机制

### 4. **上下文隔离**
- 每个窗口独立的服务实例
- 避免窗口间状态污染
- 支持不同配置和插件

## 🚀 最佳实践

1. **合理设计资源类型**：根据业务需求定义清晰的资源类型层次
2. **优化加载性能**：使用懒加载和 sleep 模式管理窗口资源
3. **统一保存机制**：实现标准化的数据保存和同步逻辑
4. **插件隔离**：确保不同窗口的插件不相互影响
5. **用户体验**：提供清晰的窗口标识和状态反馈

这种工作空间模式为大型低代码平台提供了强大的多项目管理能力，是企业级应用的重要架构特性。
