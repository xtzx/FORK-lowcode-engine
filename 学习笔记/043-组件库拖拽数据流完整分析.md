# 043-ç»„ä»¶åº“æ‹–æ‹½æ•°æ®æµå®Œæ•´åˆ†æ

## æ¦‚è¿°

åŸºäº `engine-core.js` æºç åˆ†æï¼Œä»ç»„ä»¶åº“é¢æ¿æ‹–å…¥æ–°ç»„ä»¶çš„æ•°æ®æµå¤„ç†è¿‡ç¨‹ï¼Œåˆ†ä¸º **RGL ç»„ä»¶** å’Œ **æ™®é€šç»„ä»¶** ä¸¤ç§æƒ…å†µï¼Œå…·æœ‰ä¸åŒçš„å¤„ç†é€»è¾‘å’Œæ•°æ®å­˜å‚¨æ—¶æœºã€‚

## æ ¸å¿ƒå‘ç°

### ğŸ“Š æ•°æ®å­˜å‚¨æ—¶æœº

- **ç»„ä»¶æ•°æ®å¹¶éåœ¨é¼ æ ‡æŒ‰ä¸‹æ—¶ç«‹å³å­˜å‚¨**
- **æ•°æ®åœ¨æ‹–æ‹½ç»“æŸï¼ˆdragendï¼‰æ—¶æ‰çœŸæ­£æ’å…¥åˆ°æ–‡æ¡£ä¸­**
- **æ‹–æ‹½å¼€å§‹å’Œè¿›è¡Œä¸­åªæ˜¯é¢„è§ˆå’Œå®šä½é˜¶æ®µ**

### ğŸ”„ å¤„ç†å·®å¼‚

- **RGL ç»„ä»¶**ï¼šé‡‡ç”¨åŸç”Ÿæ‹–æ‹½æœºåˆ¶ + ç‰¹æ®Šäº‹ä»¶å¤„ç†
- **æ™®é€šç»„ä»¶**ï¼šé‡‡ç”¨ä¼ ç»Ÿ sensor å®šä½ + dropLocation æœºåˆ¶

---

## 1. æ‹–æ‹½å¯åŠ¨é˜¶æ®µ - Dragon.from æ–¹æ³•

### 1.1 ç»„ä»¶åº“é¢æ¿ç»‘å®š

```typescript
// engine-core.js è¡Œ 37746-37764
Dragon.prototype.from = function(shell, boost) {
    var mousedown = function mousedown(e) {
        // 1. è¿‡æ»¤å³é”®å’ŒESCé”®
        if (e.which === 3 || e.button === 2) {
            return;
        }

        // 2. é€šè¿‡boostå‡½æ•°è·å–æ‹–æ‹½å¯¹è±¡
        var dragObject = boost(e);  // âš¡ å…³é”®ï¼šä»ç»„ä»¶åº“è·å–ç»„ä»¶æ•°æ®
        if (!dragObject) {
            return;
        }

        // 3. å¯åŠ¨æ‹–æ‹½æµç¨‹
        _this.boost(dragObject, e);
    };

    // ç»‘å®šåˆ°ç»„ä»¶åº“é¢æ¿
    shell.addEventListener('mousedown', mousedown);
    return function() {
        shell.removeEventListener('mousedown', mousedown);
    };
};
```

### 1.2 boostå‡½æ•°è·å–dragObject

```typescript
// ç»„ä»¶åº“é¢æ¿çš„boostå‡½æ•°é€šå¸¸è¿”å›ï¼š
// æ–°ç»„ä»¶æ‹–æ‹½å¯¹è±¡ï¼ˆNodeDataç±»å‹ï¼‰
const dragObject = {
    type: 'NodeData',              // æ ‡è¯†ä¸ºæ–°ç»„ä»¶æ•°æ®
    data: {                        // ç»„ä»¶Schemaæ•°æ®
        componentName: 'Button',
        props: { ... },
        children: [ ... ]
    }
};
```

**âš ï¸ é‡è¦ï¼šæ­¤æ—¶æ•°æ®ä»…å­˜åœ¨äºå†…å­˜ä¸­çš„dragObjectï¼Œå°šæœªæ’å…¥æ–‡æ¡£**

---

## 2. æ™®é€šç»„ä»¶æ‹–æ‹½æ•°æ®æµ

### 2.1 æµç¨‹å›¾

```mermaid
graph TD
    subgraph "å¯åŠ¨é˜¶æ®µ"
        A1[ç”¨æˆ·æŒ‰ä¸‹é¼ æ ‡] --> B1[Dragon.fromè§¦å‘]
        B1 --> C1[boostå‡½æ•°è·å–dragObject]
        C1 --> D1["dragObject = {<br/>type: 'NodeData',<br/>data: schema}"]
        D1 --> E1[Dragon.boostå¯åŠ¨æ‹–æ‹½]
    end

    subgraph "æ‹–æ‹½è¿›è¡Œé˜¶æ®µ"
        E1 --> F1[é¼ æ ‡ç§»åŠ¨è§¦å‘dragäº‹ä»¶]
        F1 --> G1[sensor.locateå®šä½æŠ•æ”¾ä½ç½®]
        G1 --> H1[æ›´æ–°dropLocationä¿¡æ¯]
        H1 --> I1[æ˜¾ç¤ºæŠ•æ”¾æŒ‡ç¤ºå™¨]
    end

    subgraph "ç»“æŸé˜¶æ®µ - æ•°æ®çœŸæ­£å­˜å‚¨"
        I1 --> J1[é¼ æ ‡é‡Šæ”¾è§¦å‘dragend]
        J1 --> K1[æ£€æŸ¥dropLocation.valid]
        K1 --> L1{æ˜¯å¦æœ‰æ•ˆæŠ•æ”¾ä½ç½®?}
        L1 -->|æ˜¯| M1[è°ƒç”¨insertChildrenå‡½æ•°]
        M1 --> N1[è°ƒç”¨insertChildåˆ›å»ºNode]
        N1 --> O1[container.children.insertæ’å…¥]
        O1 --> P1[ğŸ“ æ•°æ®æ­£å¼å­˜å…¥æ–‡æ¡£]
        L1 -->|å¦| Q1[ä¸¢å¼ƒdragObjectï¼Œä¸å­˜å‚¨]
    end

    style D1 fill:#fff3e0
    style P1 fill:#c8e6c9
    style Q1 fill:#ffcdd2
```

### 2.2 å…³é”®ä»£ç æµç¨‹

#### 2.2.1 æ‹–æ‹½å¼€å§‹ï¼ˆdragstartï¼‰

```typescript
// engine-core.js è¡Œ 37773+
Dragon.prototype.boost = function(dragObject, boostEvent) {
    // 1. è®¾ç½®æ‹–æ‹½çŠ¶æ€ï¼Œä½†ä¸å­˜å‚¨æ•°æ®
    this.setDraggingState(true);

    // 2. åˆ›å»ºå®šä½äº‹ä»¶
    var locateEvent = createLocateEvent(boostEvent);

    // 3. è§¦å‘æ‹–æ‹½å¼€å§‹äº‹ä»¶
    this.emitter.emit('dragstart', locateEvent);

    // âš¡ æ­¤æ—¶dragObjectä»…åœ¨å†…å­˜ä¸­ï¼Œæœªå­˜å‚¨åˆ°æ–‡æ¡£
};
```

#### 2.2.2 æ‹–æ‹½è¿›è¡Œä¸­ï¼ˆdragï¼‰

```typescript
// æ™®é€šç»„ä»¶çš„æ‹–æ‹½å¤„ç†ï¼ˆéRGLï¼‰
var drag = function drag(e) {
    var locateEvent = createLocateEvent(e);
    var sensor = chooseSensor(locateEvent);

    if (sensor) {
        // å®šä½æŠ•æ”¾ä½ç½®ï¼Œä½†ä¸å®é™…æ’å…¥æ•°æ®
        sensor.locate(locateEvent);
        // æ˜¾ç¤ºæŠ•æ”¾æŒ‡ç¤ºå™¨
    } else {
        designer.clearLocation();
    }

    // å‘é€æ‹–æ‹½è¿›è¡Œäº‹ä»¶
    _this.emitter.emit('drag', locateEvent);
};
```

#### 2.2.3 æ‹–æ‹½ç»“æŸï¼ˆdragendï¼‰- æ•°æ®çœŸæ­£å­˜å‚¨

```typescript
// engine-core.js è¡Œ 40430-40468
this.dragon.onDragend(function (e) {
    var dragObject = e.dragObject;
    var loc = _this._dropLocation;  // æŠ•æ”¾ä½ç½®ä¿¡æ¯

    if (loc && isLocationChildrenDetail(loc.detail) && loc.detail.valid !== false) {
        var nodes;

        if (isDragNodeDataObject(dragObject)) {
            // ğŸ“ å…³é”®ï¼šå¤„ç†æ–°ç»„ä»¶æ•°æ®ï¼ˆä»ç»„ä»¶åº“æ‹–å…¥ï¼‰
            var nodeData = Array.isArray(dragObject.data) ? dragObject.data : [dragObject.data];

            // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„NodeSchema
            var isNotNodeSchema = nodeData.find(item => !isNodeSchema(item));
            if (isNotNodeSchema) {
                return; // æ•°æ®æ— æ•ˆï¼Œä¸å­˜å‚¨
            }

            // âš¡ çœŸæ­£çš„æ•°æ®æ’å…¥å‘ç”Ÿåœ¨è¿™é‡Œ
            nodes = insertChildren(loc.target, nodeData, loc.detail.index);
        }

        if (nodes) {
            // é€‰ä¸­æ–°æ’å…¥çš„èŠ‚ç‚¹
            loc.document.selection.selectAll(nodes.map(o => o.id));
            // è¿½è¸ªç¬¬ä¸€ä¸ªèŠ‚ç‚¹
            setTimeout(() => _this.activeTracker.track(nodes[0]), 10);
        }
    }
    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„æŠ•æ”¾ä½ç½®ï¼ŒdragObjectè¢«ä¸¢å¼ƒï¼Œæ•°æ®ä¸å­˜å‚¨
});
```

#### 2.2.4 æ•°æ®æ’å…¥æ ¸å¿ƒå‡½æ•°

```typescript
// engine-core.js è¡Œ 30646-30677
function insertChild(container, thing, at, copy) {
    var node;

    if (isNodeSchema(thing)) {
        // ä»Schemaåˆ›å»ºçœŸæ­£çš„Nodeå¯¹è±¡
        node = container.document.createNode(thing);
    }

    if (isNode(node)) {
        // æ’å…¥åˆ°å®¹å™¨çš„childrenä¸­
        container.children.insert(node, at);
        return node;
    }

    return null;
}

function insertChildren(container, nodes, at, copy) {
    var results = [];
    while (node = nodes.pop()) {
        // é€ä¸ªæ’å…¥å­èŠ‚ç‚¹
        node = insertChild(container, node, at);
        results.push(node);
    }
    return results;
}
```

---

## 3. RGL ç»„ä»¶æ‹–æ‹½æ•°æ®æµ

### 3.1 RGL ç»„ä»¶è¯†åˆ«

```typescript
// engine-core.js è¡Œ 30384-30394
Node.prototype.getRGL = function() {
    var isRGLContainerNode = this.isRGLContainer;
    var isRGLNode = this.getParent()?.isRGLContainer;
    var isRGL = isRGLContainerNode || (isRGLNode && (!isContainerNode || !isEmptyNode));
    var rglNode = isRGLContainerNode ? this : (isRGL ? this.getParent() : null);

    return {
        isRGL,
        rglNode,
        // ...
    };
};
```

### 3.2 RGL æµç¨‹å›¾

```mermaid
graph TD
    subgraph "å¯åŠ¨é˜¶æ®µ"
        A2[ç”¨æˆ·æŒ‰ä¸‹é¼ æ ‡] --> B2[Dragon.fromè§¦å‘]
        B2 --> C2[boostå‡½æ•°è·å–dragObject]
        C2 --> D2[dragObject ç­‰äº type=NodeData; data=schema]
        D2 --> E2[Dragon.boostå¯åŠ¨æ‹–æ‹½]
    end

    subgraph "RGLç‰¹æ®Šå¤„ç†"
        E2 --> F2[é¼ æ ‡ç§»åŠ¨è§¦å‘dragäº‹ä»¶]
        F2 --> G2[æ£€æµ‹isRGLä¸ºtrue]
        G2 --> H2[å‘é€rgl.switch startäº‹ä»¶]
        H2 --> I2[ç¦ç”¨åŸç”Ÿæ‹–æ‹½é˜»æ–­]
        I2 --> J2[emitter.emit rgl.sleeping false]
    end

    subgraph "RGLæ‹–æ‹½è¿›è¡Œ"
        J2 --> K2[æ£€æŸ¥æ˜¯å¦ä»åŒä¸€RGLèŠ‚ç‚¹æ‹–æ‹½]
        K2 --> L2{åŒä¸€RGLèŠ‚ç‚¹?}
        L2 -->|æ˜¯| M2[æ¸…é™¤å®šä½ ä¸ç§»åŠ¨æ•°æ®]
        L2 -->|å¦| N2[å°è¯•å®šä½åˆ°ç›®æ ‡RGLå®¹å™¨]
        N2 --> O2[å‘é€rgl.add.placeholderäº‹ä»¶]
        O2 --> P2[æ˜¾ç¤ºRGLæŠ•æ”¾é¢„è§ˆ]
    end

    subgraph "RGLç»“æŸé˜¶æ®µ"
        M2 --> Q2[é¼ æ ‡é‡Šæ”¾]
        P2 --> Q2
        Q2 --> R2[æ£€æŸ¥ canDrop å’Œ dragging çŠ¶æ€]
        R2 --> S2{å¯ä»¥æŠ•æ”¾?}
        S2 -->|æ˜¯| T2[å‘é€rgl.dropäº‹ä»¶]
        T2 --> U2[RGLå®¹å™¨å¤„ç†èŠ‚ç‚¹æ’å…¥]
        U2 --> V2[æ•°æ®å­˜å…¥RGLå¸ƒå±€ç³»ç»Ÿ]
        S2 -->|å¦| W2[å‘é€rgl.remove.placeholder]
        W2 --> X2[ä¸¢å¼ƒdragObject]
    end

    style D2 fill:#fff3e0
    style V2 fill:#c8e6c9
    style X2 fill:#ffcdd2
```

### 3.3 RGL ç‰¹æ®Šå¤„ç†ä»£ç 

#### 3.3.1 RGL æ‹–æ‹½å¼€å§‹è¯†åˆ«

```typescript
// engine-core.js è¡Œ 34687-34698
var rglNode = node?.getParent();
var isRGLNode = rglNode?.isRGLContainer;

if (isRGLNode) {
    // è·³è¿‡resize handle
    if (downEvent.target.classList.contains('react-resizable-handle')) return;

    // ç¦æ­¢å¤šé€‰
    isMulti = false;

    // å‘é€RGLåˆ‡æ¢å¼€å§‹äº‹ä»¶
    designer.dragon.emitter.emit('rgl.switch', {
        action: 'start',
        rglNode: rglNode
    });
}
```

#### 3.3.2 RGL æ‹–æ‹½è¿›è¡Œä¸­å¤„ç†

```typescript
// engine-core.js è¡Œ 37845-37884
var {isRGL, rglNode} = getRGL(e);

if (isRGL) {
    // å¯ç”¨RGLæ‹–æ‹½æ¨¡å¼
    this.emitter.emit('rgl.sleeping', false);

    // æ£€æŸ¥æ˜¯å¦ä»åŒä¸€RGLèŠ‚ç‚¹å†…æ‹–æ‹½
    if (fromRglNode && fromRglNode.id === rglNode.id) {
        console.log('æ˜¯ä»åŒä¸€ä¸ªRGLèŠ‚ç‚¹å†…æ‹–æ‹½');
        designer.clearLocation();
        this.clearState();
        this.emitter.emit('drag', locateEvent);
        return;
    }

    // å°è¯•åœ¨ç›®æ ‡ä½ç½®å®šä½
    this._canDrop = !!(sensor?.locate(locateEvent));
    if (this._canDrop) {
        console.log('å°è¯•åœ¨ç›®æ ‡ä½ç½®è¿›è¡Œå®šä½ï¼Œåˆ¤æ–­å¯ä»¥æ”¾ç½®');

        // å‘é€æ·»åŠ å ä½ç¬¦äº‹ä»¶
        this.emitter.emit('rgl.add.placeholder', {
            rglNode: rglNode,
            fromRglNode: fromRglNode,
            node: locateEvent.dragObject?.nodes[0],
            event: e
        });

        designer.clearLocation();
        this.clearState();
        this.emitter.emit('drag', locateEvent);
        return;
    }
}
```

#### 3.3.3 RGL æ‹–æ‹½ç»“æŸå¤„ç†

```typescript
// engine-core.js è¡Œ 37957-37977
var {isRGL, rglNode} = getRGL(e);

if (isRGL && this._canDrop && this._dragging) {
    var tarNode = dragObject && dragObject.nodes?.[0];

    if (tarNode && rglNode.id !== tarNode.id) {
        // é¿å…æ­»å¾ªç¯
        this.emitter.emit('rgl.drop', {
            rglNode: rglNode,
            node: tarNode
        });

        // é€‰ä¸­æŠ•æ”¾çš„èŠ‚ç‚¹
        var selection = designer.project.currentDocument?.selection;
        selection?.select(tarNode.id);
    }
}

// ç§»é™¤RGLå ä½ç¬¦
this.emitter.emit('rgl.remove.placeholder');
```

---

## 4. å…³é”®å·®å¼‚å¯¹æ¯”

### 4.1 æ•°æ®å­˜å‚¨æ—¶æœºå¯¹æ¯”

| é˜¶æ®µ                | æ™®é€šç»„ä»¶           | RGLç»„ä»¶                   | æ•°æ®çŠ¶æ€               |
| ------------------- | ------------------ | ------------------------- | ---------------------- |
| **mousedown** | åˆ›å»ºdragObject     | åˆ›å»ºdragObject            | å†…å­˜ä¸­ï¼Œæœªå­˜å‚¨         |
| **dragstart** | è®¾ç½®æ‹–æ‹½çŠ¶æ€       | è®¾ç½®æ‹–æ‹½çŠ¶æ€ + rgl.switch | å†…å­˜ä¸­ï¼Œæœªå­˜å‚¨         |
| **drag**      | sensorå®šä½         | RGLç‰¹æ®Šå®šä½é€»è¾‘           | å†…å­˜ä¸­ï¼Œæœªå­˜å‚¨         |
| **dragend**   | insertChildrenå­˜å‚¨ | rgl.dropäº‹ä»¶å­˜å‚¨          | **çœŸæ­£å­˜å…¥æ–‡æ¡£** |

### 4.2 å¤„ç†æœºåˆ¶å¯¹æ¯”

| ç‰¹æ€§               | æ™®é€šç»„ä»¶               | RGLç»„ä»¶          |
| ------------------ | ---------------------- | ---------------- |
| **å®šä½æ–¹å¼** | sensor.locate()        | RGLå®¹å™¨å®šä½      |
| **æŠ•æ”¾é¢„è§ˆ** | æ ‡å‡†dropLocationæŒ‡ç¤ºå™¨ | rgl.placeholder  |
| **æ•°æ®æ’å…¥** | insertChildrenç›´æ¥æ’å…¥ | rgl.dropäº‹ä»¶å¤„ç† |
| **äº‹ä»¶ç³»ç»Ÿ** | æ ‡å‡†dragäº‹ä»¶           | RGLä¸“ç”¨äº‹ä»¶      |

### 4.3 é”™è¯¯å¤„ç†å·®å¼‚

```typescript
// æ™®é€šç»„ä»¶ï¼šæ— æ•ˆæŠ•æ”¾ä½ç½®ç›´æ¥ä¸¢å¼ƒ
if (!loc || !loc.detail.valid) {
    // dragObjectè¢«ä¸¢å¼ƒï¼Œæ•°æ®ä¸å­˜å‚¨
    return;
}

// RGLç»„ä»¶ï¼šcanDropæ£€æŸ¥
if (!this._canDrop || !this._dragging) {
    // å‘é€ç§»é™¤å ä½ç¬¦äº‹ä»¶ï¼Œæ•°æ®ä¸å­˜å‚¨
    this.emitter.emit('rgl.remove.placeholder');
    return;
}
```

---

## 5. æ•°æ®æµæ€»ç»“

### 5.1 æ ¸å¿ƒåŸåˆ™

1. **å»¶è¿Ÿå­˜å‚¨**ï¼šæ•°æ®å§‹ç»ˆåœ¨dragendé˜¶æ®µæ‰çœŸæ­£å­˜å…¥æ–‡æ¡£
2. **çŠ¶æ€é©±åŠ¨**ï¼šé€šè¿‡_draggingã€_canDropç­‰çŠ¶æ€æ§åˆ¶æµç¨‹
3. **äº‹ä»¶é©±åŠ¨**ï¼šæ™®é€šç»„ä»¶ç”¨æ ‡å‡†äº‹ä»¶ï¼ŒRGLç”¨ä¸“ç”¨äº‹ä»¶ç³»ç»Ÿ

### 5.2 æ€§èƒ½ä¼˜åŒ–ç‚¹

- **å†…å­˜æš‚å­˜**ï¼šæ‹–æ‹½è¿‡ç¨‹ä¸­æ•°æ®ä»…åœ¨å†…å­˜ä¸­ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œ
- **é¢„æ£€éªŒè¯**ï¼šdragendæ—¶éªŒè¯æŠ•æ”¾ä½ç½®æœ‰æ•ˆæ€§ï¼Œæ— æ•ˆåˆ™ç›´æ¥ä¸¢å¼ƒ
- **çŠ¶æ€ç¼“å­˜**ï¼šé€šè¿‡çŠ¶æ€æ ‡è®°é¿å…é‡å¤è®¡ç®—

### 5.3 ä¸šåŠ¡å½±å“

- **æ’¤é”€é‡åš**ï¼šç”±äºæ•°æ®åœ¨dragendæ—¶æ‰å­˜å‚¨ï¼Œæ’¤é”€é‡åšé€»è¾‘æ›´æ¸…æ™°
- **æ€§èƒ½è¡¨ç°**ï¼šå»¶è¿Ÿå­˜å‚¨é¿å…äº†æ‹–æ‹½è¿‡ç¨‹ä¸­çš„æ€§èƒ½æŠ–åŠ¨
- **ç”¨æˆ·ä½“éªŒ**ï¼šRGLç»„ä»¶çš„ç‰¹æ®Šå¤„ç†æä¾›äº†æ›´æµç•…çš„ç½‘æ ¼å¸ƒå±€ä½“éªŒ

---

## 6. è°ƒè¯•å»ºè®®

### 6.1 å…³é”®è°ƒè¯•ç‚¹

```typescript
// 1. æ£€æŸ¥dragObjectåˆ›å»º
console.log('dragObject created:', dragObject);

// 2. æ£€æŸ¥æ‹–æ‹½çŠ¶æ€
console.log('dragging state:', dragon.dragging);

// 3. æ£€æŸ¥æŠ•æ”¾ä½ç½®
console.log('drop location:', dropLocation);

// 4. æ£€æŸ¥æ•°æ®æ’å…¥
console.log('nodes inserted:', nodes);
```

### 6.2 å¸¸è§é—®é¢˜æ’æŸ¥

- **æ•°æ®æœªå­˜å‚¨**ï¼šæ£€æŸ¥dropLocation.validå’Œloc.detail.valid
- **RGLæŠ•æ”¾å¤±è´¥**ï¼šæ£€æŸ¥_canDropçŠ¶æ€å’Œrgl.dropäº‹ä»¶
- **æ€§èƒ½é—®é¢˜**ï¼šå…³æ³¨dragendé˜¶æ®µçš„insertChildrenæ€§èƒ½

è¿™å¥—æ•°æ®æµè®¾è®¡ç¡®ä¿äº†æ‹–æ‹½æ“ä½œçš„æ€§èƒ½å’Œå¯é æ€§ï¼ŒåŒæ—¶ä¸ºä¸åŒç±»å‹çš„ç»„ä»¶æä¾›äº†é’ˆå¯¹æ€§çš„å¤„ç†ç­–ç•¥ã€‚
